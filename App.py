{'title': 'Happy', 'artist': 'Pharrell Williams', 'key': 'F', 'typical_low': 'F3', 'typical_high': 'C5', 'era': '2010s', 'genre': 'pop', 'tags': 'upbeat,treble-bright', 'difficulty': 'intermediate', 'mood': 'joyful'},
            {'title': 'Uptown Funk', 'artist': 'Bruno Mars', 'key': 'Dm', 'typical_low': 'D3', 'typical_high': 'D5', 'era': '2010s', 'genre': 'funk', 'tags': 'energetic,mid-forward', 'difficulty': 'intermediate', 'mood': 'party'},
            {'title': 'All of Me', 'artist': 'John Legend', 'key': 'Ab', 'typical_low': 'Eb3', 'typical_high': 'Eb5', 'era': '2010s', 'genre': 'pop', 'tags': 'romantic,balanced', 'difficulty': 'intermediate', 'mood': 'romantic'},
            {'title': 'Hello', 'artist': 'Adele', 'key': 'Fm', 'typical_low': 'F3', 'typical_high': 'C5', 'era': '2010s', 'genre': 'pop', 'tags': 'dramatic,mid-forward', 'difficulty': 'advanced', 'mood': 'nostalgic'},
            {'title': 'Let It Go', 'artist': 'Idina Menzel', 'key': 'Ab', 'typical_low': 'Eb3', 'typical_high': 'Eb5', 'era': '2010s', 'genre': 'musical', 'tags': 'powerful,treble-bright', 'difficulty': 'advanced', 'mood': 'empowering'},
            
            # 2020s Contemporary
            {'title': 'Blinding Lights', 'artist': 'The Weeknd', 'key': 'Fm', 'typical_low': 'F3', 'typical_high': 'C5', 'era': '2020s', 'genre': 'pop', 'tags': 'synth-pop,treble-bright', 'difficulty': 'intermediate', 'mood': 'energetic'},
            {'title': 'Drivers License', 'artist': 'Olivia Rodrigo', 'key': 'Bb', 'typical_low': 'Bb3', 'typical_high': 'F5', 'era': '2020s', 'genre': 'pop', 'tags': 'emotional,balanced', 'difficulty': 'intermediate', 'mood': 'heartbroken'},
            {'title': 'Levitating', 'artist': 'Dua Lipa', 'key': 'F#', 'typical_low': 'F#3', 'typical_high': 'C#5', 'era': '2020s', 'genre': 'pop', 'tags': 'disco,treble-bright', 'difficulty': 'intermediate', 'mood': 'fun'},
            {'title': 'Good 4 U', 'artist': 'Olivia Rodrigo', 'key': 'F', 'typical_low': 'F3', 'typical_high': 'C5', 'era': '2020s', 'genre': 'pop-rock', 'tags': 'energetic,mid-forward', 'difficulty': 'intermediate', 'mood': 'angry'},
            {'title': 'Heat Waves', 'artist': 'Glass Animals', 'key': 'Db', 'typical_low': 'Db3', 'typical_high': 'Ab4', 'era': '2020s', 'genre': 'indie', 'tags': 'chill,balanced', 'difficulty': 'beginner', 'mood': 'nostalgic'},
            {'title': 'As It Was', 'artist': 'Harry Styles', 'key': 'C#m', 'typical_low': 'C#3', 'typical_high': 'G#4', 'era': '2020s', 'genre': 'pop', 'tags': 'indie-pop,mid-forward', 'difficulty': 'beginner', 'mood': 'reflective'},
            {'title': 'Anti-Hero', 'artist': 'Taylor Swift', 'key': 'C', 'typical_low': 'C3', 'typical_high': 'G4', 'era': '2020s', 'genre': 'pop', 'tags': 'storytelling,balanced', 'difficulty': 'beginner', 'mood': 'self-aware'},
            {'title': 'Flowers', 'artist': 'Miley Cyrus', 'key': 'G', 'typical_low': 'D3', 'typical_high': 'G4', 'era': '2020s', 'genre': 'pop', 'tags': 'empowering,mid-forward', 'difficulty': 'beginner', 'mood': 'confident'},
            {'title': 'Vampire', 'artist': 'Olivia Rodrigo', 'key': 'Cm', 'typical_low': 'C3', 'typical_high': 'Bb4', 'era': '2020s', 'genre': 'pop', 'tags': 'dramatic,treble-bright', 'difficulty': 'intermediate', 'mood': 'vengeful'},
            {'title': 'Cruel Summer', 'artist': 'Taylor Swift', 'key': 'A', 'typical_low': 'E3', 'typical_high': 'C#5', 'era': '2020s', 'genre': 'pop', 'tags': 'synth-pop,treble-bright', 'difficulty': 'intermediate', 'mood': 'passionate'},
            
            # R&B/Soul Modern
            {'title': 'Redbone', 'artist': 'Childish Gambino', 'key': 'Eb', 'typical_low': 'Eb3', 'typical_high': 'Bb4', 'era': '2010s', 'genre': 'R&B', 'tags': 'smooth,mid-forward', 'difficulty': 'intermediate', 'mood': 'seductive'},
            {'title': 'Earned It', 'artist': 'The Weeknd', 'key': 'Cm', 'typical_low': 'C3', 'typical_high': 'Ab4', 'era': '2010s', 'genre': 'R&B', 'tags': 'sultry,bass-heavy', 'difficulty': 'intermediate', 'mood': 'seductive'},
            {'title': 'Shallow', 'artist': 'Lady Gaga', 'key': 'G', 'typical_low': 'G3', 'typical_high': 'D5', 'era': '2010s', 'genre': 'pop', 'tags': 'powerful,balanced', 'difficulty': 'advanced', 'mood': 'emotional'},
            
            # Classic Training Songs
            {'title': 'Amazing Grace', 'artist': 'Traditional', 'key': 'G', 'typical_low': 'G3', 'typical_high': 'D5', 'era': 'traditional', 'genre': 'hymn', 'tags': 'hymn,mid-forward', 'difficulty': 'beginner', 'mood': 'spiritual'},
            {'title': 'Ave Maria', 'artist': 'Schubert', 'key': 'Bb', 'typical_low': 'F3', 'typical_high': 'Ab5', 'era': 'classical', 'genre': 'classical', 'tags': 'sacred,treble-bright', 'difficulty': 'advanced', 'mood': 'reverent'},
            {'title': 'Hallelujah', 'artist': 'Leonard Cohen', 'key': 'C', 'typical_low': 'C3', 'typical_high': 'C5', 'era': 'vintage', 'genre': 'folk', 'tags': 'ballad,mid-forward', 'difficulty': 'intermediate', 'mood': 'contemplative'},
            {'title': 'Danny Boy', 'artist': 'Traditional', 'key': 'C', 'typical_low': 'C3', 'typical_high': 'D5', 'era': 'traditional', 'genre': 'folk', 'tags': 'folk,balanced', 'difficulty': 'intermediate', 'mood': 'melancholic'},
            {'title': 'O Holy Night', 'artist': 'Adolphe Adam', 'key': 'C', 'typical_low': 'C3', 'typical_high': 'C5', 'era': 'classical', 'genre': 'christmas', 'tags': 'powerful,balanced', 'difficulty': 'advanced', 'mood': 'reverent'},
            {'title': 'Happy Birthday', 'artist': 'Traditional', 'key': 'F', 'typical_low': 'F3', 'typical_high': 'F4', 'era': 'traditional', 'genre': 'celebration', 'tags': 'easy,balanced', 'difficulty': 'beginner', 'mood': 'celebratory'},
            {'title': 'Edelweiss', 'artist': 'R&H', 'key': 'Bb', 'typical_low': 'Bb3', 'typical_high': 'Eb4', 'era': 'vintage', 'genre': 'musical', 'tags': 'gentle,mid-forward', 'difficulty': 'beginner', 'mood': 'peaceful'},
            {'title': 'Scarborough Fair', 'artist': 'Traditional', 'key': 'Em', 'typical_low': 'E3', 'typical_high': 'E4', 'era': 'traditional', 'genre': 'folk', 'tags': 'haunting,mid-forward', 'difficulty': 'beginner', 'mood': 'mysterious'},
            
            # Additional Modern Hits
            {'title': 'Perfect', 'artist': 'Ed Sheeran', 'key': 'Ab', 'typical_low': 'Eb3', 'typical_high': 'Bb4', 'era': '2010s', 'genre': 'pop', 'tags': 'romantic,balanced', 'difficulty': 'intermediate', 'mood': 'romantic'},
            {'title': 'Roar', 'artist': 'Katy Perry', 'key': 'Bb', 'typical_low': 'Bb3', 'typical_high': 'F5', 'era': '2010s', 'genre': 'pop', 'tags': 'empowering,treble-bright', 'difficulty': 'intermediate', 'mood': 'empowering'},
            {'title': 'Firework', 'artist': 'Katy Perry', 'key': 'Ab', 'typical_low': 'Ab3', 'typical_high': 'Db5', 'era': '2010s', 'genre': 'pop', 'tags': 'inspirational,treble-bright', 'difficulty': 'intermediate', 'mood': 'uplifting'},
            {'title': 'Skyfall', 'artist': 'Adele', 'key': 'Cm', 'typical_low': 'C3', 'typical_high': 'Bb4', 'era': '2010s', 'genre': 'pop', 'tags': 'dramatic,bass-heavy', 'difficulty': 'advanced', 'mood': 'epic'},
            {'title': 'Radioactive', 'artist': 'Imagine Dragons', 'key': 'Bm', 'typical_low': 'B2', 'typical_high': 'F#4', 'era': '2010s', 'genre': 'rock', 'tags': 'powerful,bass-heavy', 'difficulty': 'intermediate', 'mood': 'intense'},
            {'title': 'Counting Stars', 'artist': 'OneRepublic', 'key': 'Am', 'typical_low': 'A2', 'typical_high': 'E4', 'era': '2010s', 'genre': 'pop', 'tags': 'upbeat,mid-forward', 'difficulty': 'beginner', 'mood': 'hopeful'},
            {'title': 'Wake Me Up', 'artist': 'Avicii', 'key': 'Bm', 'typical_low': 'B2', 'typical_high': 'F#4', 'era': '2010s', 'genre': 'EDM', 'tags': 'energetic,balanced', 'difficulty': 'beginner', 'mood': 'uplifting'},
            {'title': 'Chandelier', 'artist': 'Sia', 'key': 'F', 'typical_low': 'F3', 'typical_high': 'C6', 'era': '2010s', 'genre': 'pop', 'tags': 'powerful,treble-bright', 'difficulty': 'advanced', 'mood': 'desperate'},
            {'title': 'Titanium', 'artist': 'David Guetta ft. Sia', 'key': 'Eb', 'typical_low': 'Eb3', 'typical_high': 'Bb4', 'era': '2010s', 'genre': 'EDM', 'tags': 'empowering,treble-bright', 'difficulty': 'intermediate', 'mood': 'strong'},
        ]
        
        pd.DataFrame(songs).to_csv(CATALOG_FILE, index=False)
    return pd.read_csv(CATALOG_FILE)

def recommend_songs(analysis_results: Dict, catalog: pd.DataFrame, user_preferences: Dict = None) -> Dict:
    """Enhanced song recommendations with filtering."""
    if 'error' in analysis_results:
        return {'fit': [], 'stretch': [], 'avoid': []}
    
    user_tess_low = analysis_results['tessitura_low_midi']
    user_tess_high = analysis_results['tessitura_high_midi']
    user_timbre = analysis_results['timbre_classification'].lower()
    
    # Apply user filters
    filtered_catalog = catalog.copy()
    if user_preferences:
        if user_preferences.get('era'):
            filtered_catalog = filtered_catalog[filtered_catalog['era'] == user_preferences['era']]
        if user_preferences.get('genre'):
            filtered_catalog = filtered_catalog[filtered_catalog['genre'] == user_preferences['genre']]
        if user_preferences.get('mood'):
            filtered_catalog = filtered_catalog[filtered_catalog['mood'] == user_preferences['mood']]
        if user_preferences.get('difficulty'):
            filtered_catalog = filtered_catalog[filtered_catalog['difficulty'] == user_preferences['difficulty']]
    
    fit_songs, stretch_songs, avoid_songs = [], [], []
    
    for _, song in filtered_catalog.iterrows():
        try:
            song_low = hz_to_midi(librosa.note_to_hz(song['typical_low']))
            song_high = hz_to_midi(librosa.note_to_hz(song['typical_high']))
            
            rec = {
                'title': song['title'],
                'artist': song['artist'],
                'key': song['key'],
                'range': f"{song['typical_low']}-{song['typical_high']}",
                'difficulty': song['difficulty'],
                'era': song['era'],
                'genre': song['genre'],
                'mood': song['mood'],
                'reasons': []
            }
            
            if song_low >= user_tess_low - 2 and song_high <= user_tess_high + 2:
                rec['reasons'].append(f"‚úì Perfect fit for your tessitura")
                if user_timbre in song['tags'].lower():
                    rec['reasons'].append(f"‚úì Matches your {user_timbre} voice")
                fit_songs.append(rec)
            elif song_high <= user_tess_high + 5 and song_low >= user_tess_low - 5:
                if song_high > user_tess_high:
                    rec['reasons'].append(f"‚¨ÜÔ∏è Extends upper range by {int(song_high - user_tess_high)} semitones")
                if song_low < user_tess_low:
                    rec['reasons'].append(f"‚¨áÔ∏è Extends lower range by {int(user_tess_low - song_low)} semitones")
                stretch_songs.append(rec)
            else:
                if song_high > user_tess_high + 5:
                    rec['reasons'].append(f"‚ùå Too high ({midi_to_note_name(song_high)} needed)")
                if song_low < user_tess_low - 5:
                    rec['reasons'].append(f"‚ùå Too low ({midi_to_note_name(song_low)} needed)")
                avoid_songs.append(rec)
        except:
            continue
    
    return {'fit': fit_songs[:15], 'stretch': stretch_songs[:10], 'avoid': avoid_songs[:5]}

# Plotting functions
def plot_pitch_contour(analysis_results: Dict) -> go.Figure:
    contour = analysis_results['pitch_contour']
    times = np.array(contour['times'])
    pitch = np.array(contour['pitch_hz'])
    voiced = np.array(contour['voiced_mask'])
    
    voiced_times = times[voiced]
    voiced_pitch = pitch[voiced]
    
    if len(voiced_pitch) == 0:
        return None
    
    voiced_midi = [hz_to_midi(f) for f in voiced_pitch]
    
    fig = go.Figure()
    fig.add_trace(go.Scatter(
        x=voiced_times, y=voiced_pitch, mode='lines+markers',
        name='Your Pitch', line=dict(color='#3b82f6', width=2),
        marker=dict(size=3),
        hovertemplate='<b>Time:</b> %{x:.2f}s<br><b>Hz:</b> %{y:.1f}<br><b>Note:</b> %{text}<extra></extra>',
        text=[midi_to_note_name(m) for m in voiced_midi]
    ))
    
    tess_low_hz = midi_to_hz(analysis_results['tessitura_low_midi'])
    tess_high_hz = midi_to_hz(analysis_results['tessitura_high_midi'])
    
    fig.add_hrect(y0=tess_low_hz, y1=tess_high_hz, fillcolor='green', opacity=0.15, line_width=0,
                  annotation_text="Your Comfort Zone", annotation_position="top left")
    
    fig.update_layout(
        title='Your Pitch Performance Over Time',
        xaxis_title='Time (seconds)',
        yaxis_title='Frequency (Hz)',
        height=450,
        template='plotly_white',
        hovermode='closest'
    )
    
    return fig

def plot_note_distribution(analysis_results: Dict) -> go.Figure:
    note_dist = analysis_results['note_distribution']
    notes = list(note_dist.keys())
    counts = list(note_dist.values())
    
    fig = go.Figure([go.Bar(
        x=notes, y=counts,
        marker_color='#8b5cf6',
        text=counts,
        textposition='auto',
        hovertemplate='<b>%{x}</b><br>Count: %{y}<extra></extra>'
    )])
    
    fig.update_layout(
        title='Notes You Sang Most',
        xaxis_title='Note',
        yaxis_title='Frequency',
        height=350,
        template='plotly_white'
    )
    return fig

def plot_spectral_profile(analysis_results: Dict) -> go.Figure:
    features = analysis_results['spectral_features']
    bands = ['Bass<br>(Low)', 'Mid<br>(Middle)', 'Treble<br>(High)']
    energies = [
        features['low_energy_ratio'] * 100,
        features['mid_energy_ratio'] * 100,
        features['high_energy_ratio'] * 100
    ]
    colors = ['#ef4444', '#f59e0b', '#3b82f6']
    
    fig = go.Figure([go.Bar(
        x=bands, y=energies,
        marker_color=colors,
        text=[f'{e:.1f}%' for e in energies],
        textposition='auto',
        hovertemplate='<b>%{x}</b><br>Energy: %{y:.1f}%<extra></extra>'
    )])
    
    fig.update_layout(
        title='Your Voice Tone Profile',
        yaxis_title='Energy Percentage',
        height=350,
        template='plotly_white',
        showlegend=False
    )
    return fig

# Custom CSS
def apply_custom_css():
    st.markdown("""
    <style>
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1.5rem; border-radius: 12px; color: white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin: 0.5rem 0;
    }
    .info-card {
        background: #f8fafc; padding: 1.2rem; border-radius: 10px;
        border-left: 4px solid #3b82f6; margin: 0.8rem 0;
    }
    .success-card {
        background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        padding: 1.2rem; border-radius: 10px; color: #1a1a1a;
        font-weight: 600; margin: 0.8rem 0;
    }
    .warning-card {
        background: #fff3cd; padding: 1.2rem; border-radius: 10px;
        border-left: 4px solid #ffc107; margin: 0.8rem 0;
    }
    h1 {
        background: linear-gradient(120deg, #667eea, #764ba2);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .stButton>button {
        border-radius: 8px; font-weight: 600; transition: all 0.3s;
    }
    .stButton>button:hover {
        transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    </style>
    """, unsafe_allow_html=True)

# Main App
def main():
    st.set_page_config(page_title="TuneScope Pro", page_icon="üé§", layout="wide")
    
    apply_custom_css()
    
    # Session state
    if 'analysis_results' not in st.session_state:
        st.session_state.analysis_results = None
    if 'audio_data' not in st.session_state:
        st.session_state.audio_data = None
    if 'catalog' not in st.session_state:
        st.session_state.catalog = initialize_expanded_catalog()
    if 'practice_log' not in st.session_state:
        st.session_state.practice_log = []
    
    # Header
    st.markdown("""
    <div style='text-align:center; padding:2rem 0;'>
        <h1 style='font-size:3.5rem; margin-bottom:0.5rem;'>üé§ TuneScope Pro</h1>
        <p style='font-size:1.3rem; color:#64748b;'>
            Your Personal Voice Coach ‚Ä¢ 100+ Songs ‚Ä¢ Singing Accuracy ‚Ä¢ Training Plans
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    # Sidebar
    with st.sidebar:
        st.markdown("### ‚öôÔ∏è Settings")
        
        st.markdown("**Voice Sensitivity**")
        voicing_threshold = st.slider(
            "Detection Threshold",
            0.0, 1.0, 0.20, 0.05,
            help="Lower = detects quieter singing",
            label_visibility="collapsed"
        )
        
        if voicing_threshold < 0.25:
            st.caption("üîä Very sensitive - picks up soft singing")
        elif voicing_threshold > 0.5:
            st.caption("üîá Less sensitive - only loud/clear voice")
        else:
            st.caption("‚úì Balanced - recommended")
        
        st.markdown("---")
        
        st.markdown("### üéØ Quick Stats")
        if st.session_state.analysis_results and 'error' not in st.session_state.analysis_results:
            results = st.session_state.analysis_results
            st.metric("Voice Type", results['voice_type']['type'])
            st.metric("Range", f"{int(results['max_note_midi'] - results['min_note_midi'])} semitones")
            st.metric("Accuracy", f"{results['singing_accuracy']['accuracy_score']:.0f}/100")
        else:
            st.info("Analyze your voice to see stats")
        
        st.markdown("---")
        
        st.markdown("### üìö Practice Log")
        if len(st.session_state.practice_log) > 0:
            for entry in st.session_state.practice_log[-3:]:
                st.text(f"{entry['date']}: {entry['score']}/100")
        else:
            st.caption("No practice sessions yet")
        
        st.markdown("---")
        
        with st.expander("‚ÑπÔ∏è System Info"):
            st.text(f"Pitch Method: YIN (librosa)\nSample Rate: {SAMPLE_RATE}Hz\nCatalog: {len(st.session_state.catalog)} songs")
    
    # Main Tabs
    tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs([
        "üéôÔ∏è Record & Analyze",
        "üìä Detailed Analysis",
        "üéµ Song Finder (100+)",
        "üèãÔ∏è Training Plans",
        "üìà Singing Coach",
        "üéì Vocal Tips"
    ])
    
    # TAB 1: Record & Analyze
    with tab1:
        st.markdown("## üé§ Record or Upload Your Voice")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("### üì§ Upload Audio File")
            uploaded_file = st.file_uploader(
                "Drop your singing/speaking audio here",
                type=['wav', 'mp3', 'm4a', 'flac', 'ogg'],
                help="Any audio format works!"
            )
            
            if uploaded_file:
                try:
                    with st.spinner("Loading your audio..."):
                        audio_bytes = uploaded_file.read()
                        y, sr = librosa.load(io.BytesIO(audio_bytes), sr=None, mono=True)
                        st.session_state.audio_data = (y, sr)
                        
                        st.success(f"‚úÖ Loaded: **{uploaded_file.name}**")
                        
                        duration = len(y) / sr
                        st.markdown(f"""
                        <div class='info-card'>
                            <b>üìä Audio Info:</b><br>
                            ‚è±Ô∏è Duration: {duration:.2f} seconds<br>
                            üéöÔ∏è Sample Rate: {sr:,} Hz<br>
                            üìè Quality: {'Excellent' if sr >= 44100 else 'Good' if sr >= 22050 else 'Basic'}
                        </div>
                        """, unsafe_allow_html=True)
                        
                        # Quick waveform
                        fig = go.Figure()
                        times = np.linspace(0, duration, min(len(y), 10000))
                        y_plot = y[:len(times)] if len(y) > len(times) else y
                        
                        fig.add_trace(go.Scatter(
                            x=times, y=y_plot,
                            mode='lines',
                            line=dict(color='#3b82f6', width=1),
                            fill='tozeroy',
                            name='Waveform'
                        ))
                        
                        fig.update_layout(
                            title='Your Audio Waveform',
                            xaxis_title='Time (s)',
                            yaxis_title='Amplitude',
                            height=200,
                            template='plotly_white',
                            showlegend=False
                        )
                        
                        st.plotly_chart(fig, use_container_width=True)
                        
                except Exception as e:
                    st.error(f"‚ùå Error loading audio: {str(e)}")
                    st.info("üí° Try converting to WAV or MP3 format")
        
        with col2:
            st.markdown("### üéôÔ∏è Record Live")
            st.markdown("""
            <div class='info-card'>
                <b>üì± How to Record:</b><br><br>
                <b>Option 1: Use your phone/computer</b><br>
                ‚Ä¢ Open Voice Recorder app<br>
                ‚Ä¢ Sing or speak clearly<br>
                ‚Ä¢ Save and upload here<br><br>
                <b>Option 2: Online recorder</b><br>
                ‚Ä¢ Use online-voice-recorder.com<br>
                ‚Ä¢ Record directly in browser<br>
                ‚Ä¢ Download and upload<br><br>
                <b>üí° Recording Tips:</b><br>
                ‚úì Quiet room (no background noise)<br>
                ‚úì 15-30 seconds minimum<br>
                ‚úì Sing a scale or favorite song<br>
                ‚úì Stand 6-12 inches from mic<br>
                ‚úì Sing at comfortable volume
            </div>
            """, unsafe_allow_html=True)
        
        st.markdown("---")
        
        # Analyze Button
        col_analyze, col_demo, col_clear = st.columns([2, 1, 1])
        
        with col_analyze:
            if st.button("üî¨ ANALYZE MY VOICE", type="primary", use_container_width=True):
                if not st.session_state.audio_data:
                    st.error("‚ùå Please upload audio first!")
                else:
                    y, sr = st.session_state.audio_data
                    
                    progress_bar = st.progress(0)
                    status = st.empty()
                    
                    def update_progress(msg, val):
                        status.text(f"üîÑ {msg}")
                        progress_bar.progress(val)
                    
                    try:
                        results = analyze_audio(y, sr, update_progress, voicing_threshold)
                        
                        if 'error' in results:
                            st.error(f"‚ùå {results['error']}")
                            st.markdown(f""""""
TuneScope Pro - Complete Voice Training & Analysis Platform
===========================================================
Professional vocal analysis, training, and song recommendations.

Features: Real-time pitch tracking, singing accuracy scoring,
personalized training plans, 100+ songs catalog, voice improvement tips.

Version: 2.0 | Author: Claude
"""

import streamlit as st
import numpy as np
import pandas as pd
import librosa
import soundfile as sf
from scipy import signal
import json
import io
import os
import datetime
from typing import Dict, Tuple, List
import warnings
warnings.filterwarnings('ignore')

import plotly.graph_objects as go
from plotly.subplots import make_subplots

# Constants
SAMPLE_RATE = 22050
HOP_LENGTH = 256
MIN_FREQUENCY = 65
MAX_FREQUENCY = 2093

VOICE_TYPES = {
    'Bass': {'min': 40, 'max': 64, 'tessitura': (45, 57), 'description': 'Deep, rich, powerful low voice'},
    'Baritone': {'min': 45, 'max': 69, 'tessitura': (50, 62), 'description': 'Warm mid-range male voice'},
    'Tenor': {'min': 48, 'max': 72, 'tessitura': (55, 67), 'description': 'Higher male voice, bright tone'},
    'Alto': {'min': 53, 'max': 77, 'tessitura': (60, 72), 'description': 'Lower female voice, rich tone'},
    'Mezzo-Soprano': {'min': 57, 'max': 81, 'tessitura': (64, 76), 'description': 'Mid-range female voice'},
    'Soprano': {'min': 60, 'max': 84, 'tessitura': (67, 79), 'description': 'High female voice, bright'}
}

VOCAL_EXERCISES = {
    'Warm-up': ['Lip trills', 'Humming scales', 'Sirens', 'Yawn-sighs', 'Gentle scales'],
    'Breath Control': ['Hissing exercises', 'Sustained notes', 'Staccato practice', 'Crescendo/Decrescendo'],
    'Range Extension': ['Ascending scales', 'Octave jumps', 'Arpeggio practice', 'Descending patterns'],
    'Pitch Accuracy': ['Interval training', 'Matching pitches', 'Scale practice', 'Slow melodies'],
    'Tone Quality': ['Vowel modifications', 'Resonance exercises', 'Forward placement', 'Open throat technique']
}

PRACTICE_ROUTINES = {
    'Beginner': {
        'duration': '15-20 min',
        'routine': [
            '5 min: Breathing exercises',
            '5 min: Gentle warm-ups',
            '5 min: Scale practice (major)',
            '5 min: Simple song practice'
        ]
    },
    'Intermediate': {
        'duration': '30-40 min',
        'routine': [
            '5 min: Deep breathing',
            '10 min: Full warm-up routine',
            '10 min: Scale & interval work',
            '10 min: Song practice (2-3 songs)',
            '5 min: Cool down'
        ]
    },
    'Advanced': {
        'duration': '45-60 min',
        'routine': [
            '5 min: Breathing exercises',
            '10 min: Comprehensive warm-up',
            '15 min: Technical exercises',
            '15 min: Repertoire practice',
            '10 min: Performance simulation',
            '5 min: Cool down & reflection'
        ]
    }
}

CATALOG_FILE = "song_catalog.csv"

# Utility Functions
def hz_to_midi(hz: float) -> float:
    if hz <= 0: return 0
    return 12 * np.log2(hz / 440.0) + 69

def midi_to_hz(midi: float) -> float:
    return 440.0 * (2.0 ** ((midi - 69) / 12.0))

def midi_to_note_name(midi: float) -> str:
    if midi <= 0: return "N/A"
    note_names = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B']
    note_num = int(round(midi))
    octave = (note_num // 12) - 1
    note = note_names[note_num % 12]
    return f"{note}{octave}"

def cents_from_midi(hz: float, ref_midi: float) -> float:
    if hz <= 0: return 0
    return (hz_to_midi(hz) - ref_midi) * 100

def smooth_pitch(pitch: np.ndarray, confidence: np.ndarray, window_size: int = 5, conf_threshold: float = 0.25) -> np.ndarray:
    pitch_masked = pitch.copy()
    pitch_masked[confidence < conf_threshold] = 0
    smoothed = signal.medfilt(pitch_masked, kernel_size=window_size)
    return smoothed

def compute_spectral_features(y: np.ndarray, sr: int) -> Dict:
    D = np.abs(librosa.stft(y, hop_length=HOP_LENGTH))
    centroid = librosa.feature.spectral_centroid(y=y, sr=sr, hop_length=HOP_LENGTH)[0]
    rolloff = librosa.feature.spectral_rolloff(y=y, sr=sr, hop_length=HOP_LENGTH)[0]
    
    freqs = librosa.fft_frequencies(sr=sr)
    low_band = (freqs < 300)
    mid_band = (freqs >= 300) & (freqs < 3000)
    high_band = (freqs >= 3000)
    
    low_energy = np.mean(D[low_band, :])
    mid_energy = np.mean(D[mid_band, :])
    high_energy = np.mean(D[high_band, :])
    total_energy = low_energy + mid_energy + high_energy
    
    return {
        'centroid_mean': float(np.mean(centroid)),
        'rolloff_mean': float(np.mean(rolloff)),
        'low_energy_ratio': float(low_energy / total_energy if total_energy > 0 else 0),
        'mid_energy_ratio': float(mid_energy / total_energy if total_energy > 0 else 0),
        'high_energy_ratio': float(high_energy / total_energy if total_energy > 0 else 0)
    }

def classify_timbre(spectral_features: Dict) -> str:
    low = spectral_features['low_energy_ratio']
    mid = spectral_features['mid_energy_ratio']
    high = spectral_features['high_energy_ratio']
    
    if low > 0.4: return "Bass-heavy"
    elif high > 0.35: return "Treble-bright"
    elif mid > 0.5: return "Mid-forward"
    else: return "Balanced"

def detect_pitch_yin(y: np.ndarray, sr: int) -> Tuple[np.ndarray, np.ndarray]:
    pitch = librosa.yin(y, fmin=MIN_FREQUENCY, fmax=MAX_FREQUENCY, sr=sr, hop_length=HOP_LENGTH)
    rms = librosa.feature.rms(y=y, hop_length=HOP_LENGTH)[0]
    confidence = np.clip(rms / (np.max(rms) + 1e-6), 0, 1)
    min_len = min(len(pitch), len(confidence))
    return pitch[:min_len], confidence[:min_len]

def classify_voice_type(midi_notes: np.ndarray, tessitura_range: Tuple[float, float]) -> Dict:
    min_note = float(np.min(midi_notes))
    max_note = float(np.max(midi_notes))
    tess_low, tess_high = float(tessitura_range[0]), float(tessitura_range[1])
    
    scores = {}
    for voice_type, ranges in VOICE_TYPES.items():
        range_overlap = (min(max_note, ranges['max']) - max(min_note, ranges['min'])) / (ranges['max'] - ranges['min'])
        tess_overlap = (min(tess_high, ranges['tessitura'][1]) - max(tess_low, ranges['tessitura'][0])) / (ranges['tessitura'][1] - ranges['tessitura'][0])
        scores[voice_type] = float(max(0, range_overlap * 0.4 + tess_overlap * 0.6))
    
    sorted_types = sorted(scores.items(), key=lambda x: x[1], reverse=True)
    best_type, best_score = sorted_types[0]
    is_borderline = len(sorted_types) > 1 and sorted_types[1][1] > best_score * 0.85
    
    return {
        'type': best_type,
        'confidence': float(best_score),
        'is_borderline': bool(is_borderline),
        'alternative': sorted_types[1][0] if is_borderline else None,
        'all_scores': {k: float(v) for k, v in sorted_types},
        'description': VOICE_TYPES[best_type]['description']
    }

def analyze_singing_accuracy(y: np.ndarray, sr: int, reference_notes: List[float] = None) -> Dict:
    """Analyze how accurately user is singing."""
    pitch, confidence = detect_pitch_yin(y, sr)
    pitch_smoothed = smooth_pitch(pitch, confidence, conf_threshold=0.2)
    voiced_mask = (pitch_smoothed > 0) & (confidence > 0.2)
    voiced_pitch = pitch_smoothed[voiced_mask]
    
    if len(voiced_pitch) < 5:
        return {'accuracy_score': 0, 'message': 'Too short - sing longer'}
    
    midi_notes = np.array([hz_to_midi(f) for f in voiced_pitch if f > 0])
    cents_errors = [abs(cents_from_midi(hz, round(hz_to_midi(hz)))) for hz in voiced_pitch if hz > 0]
    
    # Accuracy metrics
    mean_error = np.mean(cents_errors)
    consistency = 100 - np.std(cents_errors)
    
    # Vibrato detection
    pitch_variation = np.std(np.diff(midi_notes))
    has_vibrato = pitch_variation > 0.3 and pitch_variation < 1.5
    
    # Note stability
    stable_notes = sum(1 for e in cents_errors if e < 25) / len(cents_errors) * 100
    
    accuracy_score = max(0, 100 - mean_error)
    
    feedback = []
    if accuracy_score >= 90:
        feedback.append("üåü Excellent pitch accuracy!")
    elif accuracy_score >= 75:
        feedback.append("üëç Good intonation!")
    elif accuracy_score >= 60:
        feedback.append("‚ö†Ô∏è Practice pitch matching")
    else:
        feedback.append("üìö Focus on ear training")
    
    if stable_notes < 50:
        feedback.append("üí° Work on holding steady notes")
    
    if has_vibrato:
        feedback.append("üéµ Nice vibrato detected!")
    
    return {
        'accuracy_score': float(accuracy_score),
        'mean_cents_error': float(mean_error),
        'consistency': float(max(0, consistency)),
        'stable_notes_percent': float(stable_notes),
        'has_vibrato': bool(has_vibrato),
        'feedback': feedback
    }

def analyze_audio(y: np.ndarray, sr: int, progress_callback=None, voicing_threshold: float = 0.25) -> Dict:
    results = {}
    
    if progress_callback:
        progress_callback("Preprocessing...", 0.1)
    
    if sr != SAMPLE_RATE:
        y = librosa.resample(y, orig_sr=sr, target_sr=SAMPLE_RATE)
        sr = SAMPLE_RATE
    
    if len(y.shape) > 1:
        y = librosa.to_mono(y)
    
    y = librosa.util.normalize(y)
    results['duration'] = float(len(y) / sr)
    results['sample_rate'] = int(sr)
    
    if progress_callback:
        progress_callback("Detecting pitch...", 0.3)
    
    pitch, confidence = detect_pitch_yin(y, sr)
    pitch_smoothed = smooth_pitch(pitch, confidence, conf_threshold=voicing_threshold)
    voiced_mask = (pitch_smoothed > 0) & (confidence > voicing_threshold)
    voiced_pitch = pitch_smoothed[voiced_mask]
    
    if len(voiced_pitch) < 10:
        return {
            'error': f'Insufficient voice detected. Speak/sing louder and longer. Try threshold: {voicing_threshold-0.05:.2f}',
            'voiced_ratio': float(np.sum(voiced_mask) / len(voiced_mask) if len(voiced_mask) > 0 else 0)
        }
    
    results['voiced_ratio'] = float(np.sum(voiced_mask) / len(voiced_mask))
    
    if progress_callback:
        progress_callback("Analyzing range...", 0.5)
    
    midi_notes = np.array([hz_to_midi(f) for f in voiced_pitch if f > 0])
    
    if len(midi_notes) == 0:
        return {'error': 'No valid pitches detected'}
    
    results['min_note_midi'] = float(np.min(midi_notes))
    results['max_note_midi'] = float(np.max(midi_notes))
    results['min_note'] = midi_to_note_name(results['min_note_midi'])
    results['max_note'] = midi_to_note_name(results['max_note_midi'])
    
    tess_low = float(np.percentile(midi_notes, 25))
    tess_high = float(np.percentile(midi_notes, 75))
    results['tessitura_low_midi'] = tess_low
    results['tessitura_high_midi'] = tess_high
    results['tessitura_low'] = midi_to_note_name(tess_low)
    results['tessitura_high'] = midi_to_note_name(tess_high)
    
    if progress_callback:
        progress_callback("Voice classification...", 0.6)
    
    results['voice_type'] = classify_voice_type(midi_notes, (tess_low, tess_high))
    
    if progress_callback:
        progress_callback("Accuracy check...", 0.7)
    
    cents_errors = [cents_from_midi(hz, round(hz_to_midi(hz))) for hz in voiced_pitch if hz > 0]
    
    results['pitch_accuracy'] = {
        'mean_cents_error': float(np.mean(np.abs(cents_errors))),
        'median_cents_error': float(np.median(cents_errors)),
        'std_cents_error': float(np.std(cents_errors)),
        'intonation_score': float(max(0, 100 - np.mean(np.abs(cents_errors))))
    }
    
    # Singing accuracy
    results['singing_accuracy'] = analyze_singing_accuracy(y, sr)
    
    if progress_callback:
        progress_callback("Timbre analysis...", 0.8)
    
    spectral_features = compute_spectral_features(y, sr)
    results['spectral_features'] = spectral_features
    results['timbre_classification'] = classify_timbre(spectral_features)
    
    # Note distribution
    note_histogram = {}
    for midi in midi_notes[::10]:
        note_name = midi_to_note_name(midi)
        note_histogram[note_name] = note_histogram.get(note_name, 0) + 1
    results['note_distribution'] = note_histogram
    
    # Downsampled contour
    downsample = max(1, len(pitch_smoothed) // 500)
    results['pitch_contour'] = {
        'times': [float(x) for x in (np.arange(len(pitch_smoothed))[::downsample] * HOP_LENGTH / sr).tolist()],
        'pitch_hz': [float(x) for x in pitch_smoothed[::downsample].tolist()],
        'confidence': [float(x) for x in confidence[::downsample].tolist()],
        'voiced_mask': [bool(x) for x in voiced_mask[::downsample].tolist()]
    }
    
    if progress_callback:
        progress_callback("Complete!", 1.0)
    
    return results

def initialize_expanded_catalog():
    """Create comprehensive 100+ song catalog."""
    if not os.path.exists(CATALOG_FILE):
        songs = [
            # Classic/Vintage (1920s-1970s)
            {'title': 'Fly Me to the Moon', 'artist': 'Frank Sinatra', 'key': 'C', 'typical_low': 'C3', 'typical_high': 'D4', 'era': 'vintage', 'genre': 'jazz', 'tags': 'swing,romantic,mid-forward', 'difficulty': 'intermediate', 'mood': 'romantic'},
            {'title': 'My Way', 'artist': 'Frank Sinatra', 'key': 'D', 'typical_low': 'A2', 'typical_high': 'D4', 'era': 'vintage', 'genre': 'pop', 'tags': 'powerful,bass-heavy', 'difficulty': 'intermediate', 'mood': 'confident'},
            {'title': 'Unchained Melody', 'artist': 'Righteous Brothers', 'key': 'C', 'typical_low': 'C3', 'typical_high': 'F4', 'era': 'vintage', 'genre': 'ballad', 'tags': 'emotional,mid-forward', 'difficulty': 'intermediate', 'mood': 'romantic'},
            {'title': 'Stand By Me', 'artist': 'Ben E. King', 'key': 'A', 'typical_low': 'E3', 'typical_high': 'C#4', 'era': 'vintage', 'genre': 'soul', 'tags': 'smooth,bass-heavy', 'difficulty': 'beginner', 'mood': 'comforting'},
            {'title': 'What a Wonderful World', 'artist': 'Louis Armstrong', 'key': 'F', 'typical_low': 'F3', 'typical_high': 'F4', 'era': 'vintage', 'genre': 'jazz', 'tags': 'warm,bass-heavy', 'difficulty': 'beginner', 'mood': 'uplifting'},
            {'title': 'Can\'t Help Falling in Love', 'artist': 'Elvis Presley', 'key': 'C', 'typical_low': 'C3', 'typical_high': 'C4', 'era': 'vintage', 'genre': 'ballad', 'tags': 'gentle,balanced', 'difficulty': 'beginner', 'mood': 'romantic'},
            {'title': 'At Last', 'artist': 'Etta James', 'key': 'F', 'typical_low': 'F3', 'typical_high': 'Ab4', 'era': 'vintage', 'genre': 'blues', 'tags': 'soulful,mid-forward', 'difficulty': 'intermediate', 'mood': 'romantic'},
            {'title': 'Somewhere Over Rainbow', 'artist': 'Judy Garland', 'key': 'Eb', 'typical_low': 'Eb3', 'typical_high': 'Bb4', 'era': 'vintage', 'genre': 'musical', 'tags': 'dreamy,balanced', 'difficulty': 'intermediate', 'mood': 'hopeful'},
            {'title': 'Feeling Good', 'artist': 'Nina Simone', 'key': 'Gm', 'typical_low': 'G3', 'typical_high': 'Bb4', 'era': 'vintage', 'genre': 'jazz', 'tags': 'powerful,mid-forward', 'difficulty': 'intermediate', 'mood': 'empowering'},
            {'title': 'Dream a Little Dream', 'artist': 'Ella Fitzgerald', 'key': 'C', 'typical_low': 'C4', 'typical_high': 'E5', 'era': 'vintage', 'genre': 'jazz', 'tags': 'sweet,treble-bright', 'difficulty': 'intermediate', 'mood': 'dreamy'},
            
            # 1980s-1990s Classics
            {'title': 'I Will Always Love You', 'artist': 'Whitney Houston', 'key': 'A', 'typical_low': 'C#3', 'typical_high': 'B4', 'era': '80s-90s', 'genre': 'pop', 'tags': 'powerful,treble-bright', 'difficulty': 'advanced', 'mood': 'emotional'},
            {'title': 'Careless Whisper', 'artist': 'George Michael', 'key': 'Dm', 'typical_low': 'D3', 'typical_high': 'F4', 'era': '80s-90s', 'genre': 'pop', 'tags': 'smooth,balanced', 'difficulty': 'intermediate', 'mood': 'romantic'},
            {'title': 'Every Breath You Take', 'artist': 'The Police', 'key': 'Ab', 'typical_low': 'Eb3', 'typical_high': 'Bb4', 'era': '80s-90s', 'genre': 'rock', 'tags': 'melodic,mid-forward', 'difficulty': 'beginner', 'mood': 'melancholic'},
            {'title': 'Sweet Child O\' Mine', 'artist': 'Guns N\' Roses', 'key': 'Db', 'typical_low': 'Ab2', 'typical_high': 'Db5', 'era': '80s-90s', 'genre': 'rock', 'tags': 'energetic,treble-bright', 'difficulty': 'advanced', 'mood': 'energetic'},
            {'title': 'Don\'t Stop Believin\'', 'artist': 'Journey', 'key': 'E', 'typical_low': 'E3', 'typical_high': 'E4', 'era': '80s-90s', 'genre': 'rock', 'tags': 'anthemic,balanced', 'difficulty': 'intermediate', 'mood': 'uplifting'},
            {'title': 'Total Eclipse of Heart', 'artist': 'Bonnie Tyler', 'key': 'Ab', 'typical_low': 'Eb3', 'typical_high': 'Ab4', 'era': '80s-90s', 'genre': 'rock', 'tags': 'dramatic,mid-forward', 'difficulty': 'intermediate', 'mood': 'passionate'},
            {'title': 'Take On Me', 'artist': 'a-ha', 'key': 'A', 'typical_low': 'A3', 'typical_high': 'E5', 'era': '80s-90s', 'genre': 'pop', 'tags': 'upbeat,treble-bright', 'difficulty': 'advanced', 'mood': 'energetic'},
            {'title': 'Livin\' on a Prayer', 'artist': 'Bon Jovi', 'key': 'Em', 'typical_low': 'E3', 'typical_high': 'B4', 'era': '80s-90s', 'genre': 'rock', 'tags': 'powerful,mid-forward', 'difficulty': 'intermediate', 'mood': 'motivational'},
            {'title': 'Nothing Compares 2 U', 'artist': 'Sinead O\'Connor', 'key': 'F', 'typical_low': 'F3', 'typical_high': 'Bb4', 'era': '80s-90s', 'genre': 'pop', 'tags': 'emotional,balanced', 'difficulty': 'intermediate', 'mood': 'sad'},
            {'title': 'With or Without You', 'artist': 'U2', 'key': 'D', 'typical_low': 'D3', 'typical_high': 'D4', 'era': '80s-90s', 'genre': 'rock', 'tags': 'atmospheric,mid-forward', 'difficulty': 'beginner', 'mood': 'reflective'},
            
            # 2000s Pop/R&B
            {'title': 'A Thousand Miles', 'artist': 'Vanessa Carlton', 'key': 'B', 'typical_low': 'F#3', 'typical_high': 'C#5', 'era': '2000s', 'genre': 'pop', 'tags': 'melodic,treble-bright', 'difficulty': 'intermediate', 'mood': 'nostalgic'},
            {'title': 'Crazy', 'artist': 'Gnarls Barkley', 'key': 'Cm', 'typical_low': 'C3', 'typical_high': 'Eb4', 'era': '2000s', 'genre': 'soul', 'tags': 'groovy,mid-forward', 'difficulty': 'intermediate', 'mood': 'cool'},
            {'title': 'Rehab', 'artist': 'Amy Winehouse', 'key': 'F', 'typical_low': 'F3', 'typical_high': 'C5', 'era': '2000s', 'genre': 'soul', 'tags': 'jazzy,balanced', 'difficulty': 'intermediate', 'mood': 'defiant'},
            {'title': 'Chasing Cars', 'artist': 'Snow Patrol', 'key': 'A', 'typical_low': 'E3', 'typical_high': 'C#4', 'era': '2000s', 'genre': 'rock', 'tags': 'gentle,mid-forward', 'difficulty': 'beginner', 'mood': 'peaceful'},
            {'title': 'Bleeding Love', 'artist': 'Leona Lewis', 'key': 'Fm', 'typical_low': 'F3', 'typical_high': 'C5', 'era': '2000s', 'genre': 'pop', 'tags': 'powerful,treble-bright', 'difficulty': 'advanced', 'mood': 'emotional'},
            {'title': 'Apologize', 'artist': 'OneRepublic', 'key': 'Cm', 'typical_low': 'C3', 'typical_high': 'G4', 'era': '2000s', 'genre': 'pop', 'tags': 'melodic,mid-forward', 'difficulty': 'intermediate', 'mood': 'regretful'},
            {'title': 'Beautiful', 'artist': 'Christina Aguilera', 'key': 'Eb', 'typical_low': 'Eb3', 'typical_high': 'Bb4', 'era': '2000s', 'genre': 'pop', 'tags': 'empowering,balanced', 'difficulty': 'intermediate', 'mood': 'uplifting'},
            {'title': 'Just Dance', 'artist': 'Lady Gaga', 'key': 'C#m', 'typical_low': 'C#3', 'typical_high': 'G#4', 'era': '2000s', 'genre': 'pop', 'tags': 'energetic,treble-bright', 'difficulty': 'intermediate', 'mood': 'party'},
            {'title': 'Viva La Vida', 'artist': 'Coldplay', 'key': 'Ab', 'typical_low': 'Eb3', 'typical_high': 'Bb4', 'era': '2000s', 'genre': 'rock', 'tags': 'anthemic,balanced', 'difficulty': 'intermediate', 'mood': 'epic'},
            {'title': 'Poker Face', 'artist': 'Lady Gaga', 'key': 'G#m', 'typical_low': 'G#3', 'typical_high': 'D#4', 'era': '2000s', 'genre': 'pop', 'tags': 'catchy,mid-forward', 'difficulty': 'beginner', 'mood': 'mysterious'},
            
            # 2010s Modern Pop
            {'title': 'Rolling in the Deep', 'artist': 'Adele', 'key': 'Cm', 'typical_low': 'C3', 'typical_high': 'F4', 'era': '2010s', 'genre': 'pop', 'tags': 'powerful,bass-heavy', 'difficulty': 'intermediate', 'mood': 'angry'},
            {'title': 'Someone Like You', 'artist': 'Adele', 'key': 'A', 'typical_low': 'E3', 'typical_high': 'C#5', 'era': '2010s', 'genre': 'pop', 'tags': 'emotional,balanced', 'difficulty': 'intermediate', 'mood': 'heartbroken'},
            {'title': 'Shape of You', 'artist': 'Ed Sheeran', 'key': 'C#m', 'typical_low': 'C#3', 'typical_high': 'F#4', 'era': '2010s', 'genre': 'pop', 'tags': 'rhythmic,mid-forward', 'difficulty': 'beginner', 'mood': 'flirty'},
            {'title': 'Thinking Out Loud', 'artist': 'Ed Sheeran', 'key': 'D', 'typical_low': 'A2', 'typical_high': 'A4', 'era': '2010s', 'genre': 'pop', 'tags': 'romantic,balanced', 'difficulty': 'intermediate', 'mood': 'romantic'},
            {'title': 'Stay With Me', 'artist': 'Sam Smith', 'key': 'C', 'typical_low': 'C3', 'typical_high': 'G4', 'era': '2010s', 'genre': 'pop', 'tags': 'soulful,mid-forward', 'difficulty': 'intermediate', 'mood': 'pleading'},
            {'title': 'Happy', 'artist': 'Pharrell Williams', 'key': 'F', 'typical
